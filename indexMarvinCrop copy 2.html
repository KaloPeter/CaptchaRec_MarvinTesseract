<!DOCTYPE html>
<html>

<head>
    <title>Page Title</title>

    <script src="https://www.marvinj.org/releases/marvinj-0.9.js"></script>
    <style>
        canvas {
            border: 2px solid black;
        }
    </style>
</head>

<body>
    <h3>Simple Image</h3>
    <img src="cpt.png" alt="cpt_3" id="o" width="250" height="110" />

    <hr>

    <h2>Result(Marvin):</h2>
    <canvas id="canvas"></canvas>
    <canvas id="canvas_r"></canvas>

    <hr>
    <h3>Cropping:</h3>

    <canvas id='c1'></canvas>
    <canvas id='c2'></canvas>

    <script>
        var original = document.getElementById('o');//<img>
        var specImg = original.src;
        var canvas = document.getElementById("canvas");
        image = new MarvinImage();
        image.load(original.src, imageLoaded);

        function imageLoaded() {
            var width = image.getWidth();
            var factor = width / 150;
            var original = image.clone();
            Marvin.scale(image.clone(), image, 150);
            var bin = MarvinColorModelConverter.rgbToBinary(image, 150);
            Marvin.morphologicalClosing(bin.clone(), bin, MarvinMath.getTrueMatrix(6, 6));
            image = MarvinColorModelConverter.binaryToRgb(bin);
            var segments = Marvin.floodfillSegmentation(image);
            var seg = segments[4];

            original.drawRect(
                Math.floor(seg.x1 * factor),//x
                Math.floor(seg.y1 * factor) - 1,//y
                Math.floor(seg.width * factor) + 5,//widht
                Math.floor(seg.height * factor) + 5,//height
                0xFFFFFFF8000);

            var pos = {
                x: Math.floor(seg.x1 * factor),//x
                y: Math.floor(seg.y1 * factor) - 1,//y
                w: Math.floor(seg.width * factor) + 5,//widht
                h: Math.floor(seg.height * factor) + 5,//height
            };
            original.draw(canvas);
            //************************************************************************************************
            //************************************************************************************************

            var canvas_x = canvas.getContext("2d");

            var canvas_r = document.getElementById('canvas_r');
            var canvas_r_x = canvas_r.getContext("2d");

            var proportion = .9; //proportien or size 
            var cw = canvas.width;
            var ch = canvas.height;
            var cx = cw / 2;
            var cy = ch / 2;

            // var sx = 0;//purple-red X
            // var sy = 0;//blue-orange y
            // var sw = 120;//red x
            // var sh = 50;//orange y


            var sx = pos.x;//purple-red X
            var sy = pos.y;//blue-orange y
            var sw = pos.w;//red x
            var sh = pos.h;//orange y

            var r = 1;//thickness of lines/boundaries

            var o = { // cropping bars
                "sx": {
                    color: "blue",
                    x: 0,
                    y: sy,
                    w: cw,
                    h: r,
                    bool: false,
                },
                "sy": {
                    color: "purple",
                    x: sx,
                    y: 0,
                    w: r,
                    h: ch,
                    bool: false,
                },
                "sw": {
                    color: "orange",
                    x: 0,
                    y: sy + sh,
                    w: cw,
                    h: r,
                    bool: false,
                },
                "sh": {
                    color: "red",
                    x: sx + sw,
                    y: 0,
                    w: r,
                    h: ch,
                    bool: false,
                }
            }

            var d = {
                x: ~~(cx - sw * proportion / 2),
                y: ~~(cy - sh * proportion / 2)
            }

            drawGuides(o);
            var imgo = Imgo(o, d);
            var img = new Image();
            img.src = specImg;

            img.onload = function () {
                drawCroppedImage(imgo);
            }

            function drawCroppedImage(imgo) {
                canvas_r_x.drawImage(img, imgo.sx, imgo.sy, imgo.sw, imgo.sh, imgo.x, imgo.y, imgo.w, imgo.h);
            }

            function Imgo(o, d) { // an object defining the cropped image
                var imgo = {
                    sx: o.sy.x,
                    sy: o.sx.y,
                    sw: o.sh.x - o.sy.x,
                    sh: o.sw.y - o.sx.y,
                    w: ~~((o.sh.x - o.sy.x) * proportion),
                    h: ~~((o.sw.y - o.sx.y) * proportion),
                    x: d.x,
                    y: d.y
                }
                return imgo;
            }

            function drawGuides(o) {
                for (k in o) {
                    canvas_x.fillStyle = o[k].color;
                    canvas_x.beginPath();
                    canvas_x.fillRect(o[k].x, o[k].y, o[k].w, o[k].h);
                }
            }

        }


        


    </script>

</body>

</html>